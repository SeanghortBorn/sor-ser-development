name: Auto Release (All Branches)

on:
  push:
    branches:
      - main
      - staging
      - production
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/**'

jobs:
  auto-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Determine environment
        id: env
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          
          if [ "$BRANCH" = "production" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "env_label=Production" >> $GITHUB_OUTPUT
            echo "env_prefix=" >> $GITHUB_OUTPUT
          elif [ "$BRANCH" = "staging" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "env_label=Staging" >> $GITHUB_OUTPUT
            echo "env_prefix=staging-" >> $GITHUB_OUTPUT
          else
            echo "environment=local" >> $GITHUB_OUTPUT
            echo "env_label=Development" >> $GITHUB_OUTPUT
            echo "env_prefix=dev-" >> $GITHUB_OUTPUT
          fi

      - name: Analyze commits and determine version bump
        id: analyze
        env:
          ENVIRONMENT: ${{ steps.env.outputs.environment }}
          BRANCH: ${{ steps.env.outputs.branch }}
        run: |
          node .github/scripts/analyze_commits.js

      - name: Check if release needed
        id: check
        run: |
          if [ -f .release_info.json ]; then
            echo "needs_release=true" >> $GITHUB_OUTPUT
            echo "Release will be created"
          else
            echo "needs_release=false" >> $GITHUB_OUTPUT
            echo "No release needed (no conventional commits found)"
          fi

      - name: Bump version
        if: steps.check.outputs.needs_release == 'true'
        env:
          ENVIRONMENT: ${{ steps.env.outputs.environment }}
        run: |
          node .github/scripts/bump_version_auto.js

      - name: Generate release notes
        if: steps.check.outputs.needs_release == 'true'
        env:
          ENVIRONMENT: ${{ steps.env.outputs.environment }}
          ENV_LABEL: ${{ steps.env.outputs.env_label }}
        run: |
          node .github/scripts/generate_release_notes.js

      - name: Update README
        if: steps.check.outputs.needs_release == 'true'
        run: |
          chmod +x .github/scripts/update_readme.sh
          ./.github/scripts/update_readme.sh ${{ steps.env.outputs.environment }}

      - name: Commit version bump
        if: steps.check.outputs.needs_release == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add version.json README.md CHANGELOG.md package.json
          git commit -m "chore(release): bump version [${{ steps.env.outputs.env_label }}] [skip ci]" || echo "No changes to commit"
          git push origin ${{ steps.env.outputs.branch }}

      - name: Read release info
        if: steps.check.outputs.needs_release == 'true'
        id: release_info
        run: |
          VERSION=$(jq -r '.version' .release_info.json)
          TITLE=$(jq -r '.title' .release_info.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT

      - name: Create Git tag
        if: steps.check.outputs.needs_release == 'true'
        run: |
          TAG="${{ steps.env.outputs.env_prefix }}v${{ steps.release_info.outputs.version }}"
          git tag -a "$TAG" -m "${{ steps.release_info.outputs.title }}"
          git push origin "$TAG"

      - name: Create GitHub Release
        if: steps.check.outputs.needs_release == 'true'
        uses: ncipollo/release-action@v1
        with:
          tag: "${{ steps.env.outputs.env_prefix }}v${{ steps.release_info.outputs.version }}"
          name: "[${{ steps.env.outputs.env_label }}] ${{ steps.release_info.outputs.title }}"
          bodyFile: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ steps.env.outputs.environment != 'production' }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up temp files
        if: always()
        run: |
          rm -f .release_info.json RELEASE_NOTES.md
